package com.xmltocfdi_3_3;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.util.HashMap;
import java.util.Map;

import net.sf.jasperreports.engine.JasperCompileManager;
import net.sf.jasperreports.engine.JasperExportManager;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.JasperReport;
import net.sf.jasperreports.engine.design.JRDesignQuery;
import net.sf.jasperreports.engine.design.JasperDesign;
import net.sf.jasperreports.engine.util.FileResolver;
import net.sf.jasperreports.engine.xml.JRXmlLoader;

public class Test {

	static public void main(String args[]) throws Exception {
		System.out.println("123...");
	}
	
	static public void createPDF() throws Exception {
		String jasperPath = "/Users/javier/Proyectos/Workana/XmlToCFDI/xmltocfdi/src/main/resources/cfdi_v3_3.jasper";
		
		//Prefiero usar el .jrxml a la aplicacion que el .jasper por que es mas facil de versionar
		String sourceFileName = jasperPath;   
		
		
		File theFile = new File(sourceFileName);
		JasperDesign jasperDesign = JRXmlLoader.load(theFile);//Se carga el archivo

		//Si el reporte va a tener un query fijo, puedes omitir este paso
		JRDesignQuery newQuery = new JRDesignQuery();
		newQuery.setText("SELECT * FROM miTabla WHERE X = Y");
		jasperDesign.setQuery(newQuery);

		//Map parameters = new HashMap();//Parametros que usa el jasperreports
		//Este parametro sirve para meter una funcion que el reporte va a ejecutar para encontrar la ruta fisica de sus imagenes
		/*parameters.put("REPORT_FILE_RESOLVER", new FileResolver() {
		                public File resolveFile(String fileName) {
		                    return new File(getServletContext().getRealPath("") + "\\mis_imagenes\\"+fileName); 
		                }
		            });*/
		//Se compila el archivo a .jasper
		JasperReport jasperReport = JasperCompileManager.compileReport(jasperDesign);

		//Aqui se llena el reporte (se ejecuta la consulta)
		Map<String, Object> params = new HashMap<String, Object>();
		params.put("emisor", "TEQUILA CARRERA SA DE CV");
		
		JasperPrint jasperPrint = new JasperPrint();
		jasperPrint = JasperFillManager.fillReport(sourceFileName, params);
		
		byte[] pdfBytes = JasperExportManager.exportReportToPdf(jasperPrint);
		createFile(pdfBytes, "/Users/javier/Proyectos/Workana/XmlToCFDI/xmltocfdi/src/main/resources/test1.pdf");
		
	}
	
	private void createFile(byte[] bytes, String pdfFilename) throws IOException {
		OutputStream os = null;
		try { 
			// Initialize a pointer 
            // in file using OutputStream 
            os = new FileOutputStream(pdfFilename); 
  
            // Starts writing the bytes in it 
            os.write(bytes); 
            System.out.println("Successfully" + " byte inserted"); 
        } 
  
        catch (IOException exc) { 
            System.out.println("Exception: " + exc); 
            throw exc;
        } finally {
        	if (os != null) {
        		os.close();
        	}
        }
	}
	
}
